#!/bin/bash -v
#
# This script locates a distribution package in a ROSE test directory.
#  examines the package and imports it as a vendor drop into an external repository.
# It assumes a layout of test dir as following:
#   x. sourcetree: a checkout copy of ROSE
#   x. build: a build dir for ROSE
# It conducts sanity check for the package, especially
#   x. Remove .svn directories
#   x. Make sure no EDG copyrighted files exist
# It imports the package which passes the check to 
#  the head of an external repository using svn_load_dirs.1.4.5.pl
# Use
#  thisScript ROSE_TOP_TEST_DIR
#
# by Liao, 7/31/2008
# Last Modified 7/30/2008
#------------------------------------------------------

REMOTE_SVN_REPOS=file:////home/liao6/test3/ROSE.MIRROR
#REMOTE_SVN_REPOS=https://outreach.scidac.gov/svn/rose

if [ $# -lt 1 ]
then
  echo This script needs one argument to run.
  echo Example: $0 ROSE_TOP_TEST_DIR 
  exit
fi

# remove previous left over temporary dir generated by svn_load_dirs.??.pl
rm -rf /tmp/svn_load_dirs*

ROSE_TOP_TEST_DIR=$1
cd ${ROSE_TOP_TEST_DIR}

# find the distribution package from top/build
ROSE_DISTRIBUTION=$(find build -name  \*source-with-EDG-binary\*.tar.gz)
if [ $? -ne 0 ]; then
   echo "Fatal error: cannot find the distribution package!"
   exit 1
fi
echo Found the ROSE distribution package: $ROSE_DISTRIBUTION

ROSE_SRC=${ROSE_TOP_TEST_DIR}/sourcetree

UPLOAD_DIR=${ROSE_TOP_TEST_DIR}/upload
rm -rf ${UPLOAD_DIR}
mkdir -p ${UPLOAD_DIR}

# unpack the package to the work dir and get the root dir of the distribution
#----------------------------------------------------
tar xzvf ${ROSE_DISTRIBUTION} -C ${UPLOAD_DIR}

cd ${UPLOAD_DIR}
ROSE_DIST_DIR=$(ls ${UPLOAD_DIR})
echo "Unpacked ROSE distribution directory is: ${ROSE_DIST_DIR}"

# Find all .svn directories and remove them
#----------------------------------------------------
find . -name .svn | xargs rm -rf

# Make sure no EDG copyrighted files exist
#----------------------------------------------------

# We search for a representative source file: il_def.h
EDG_FILES=($(find . -name il_def.h -or -name cp_gen_be.c -or -name lower_il.h))
#EDG_FILES=($(find . -name Makefile.am))
if [ ${EDG_FILES[0]} ]; then
  echo Fatal Error: Found copyrighted EDG source files:${EDG_FILES[@]}
  exit 1
fi

# and the copyright string of EDG: "Proprietary information of Edison Design Group Inc."
EDG_COPYRIGHT_STRINGS=($(find . -name \*.C -or -name \*.h -or -name \*.c -or -name \*.cpp| xargs grep 'Proprietary information of Edison Design Group Inc.'))

if [ ${EDG_COPYRIGHT_STRINGS[0]} ]; then
  echo Fatal Error: Found copyrighted EDG text in source files:${EDG_COPYRIGHT_STRINGS[@]}
  exit 2
fi

# Now we can upload the package
#--------------------------------------------------------
${ROSE_SRC}/scripts/svn_load_dirs.1.4.5.pl -no_user_input ${REMOTE_SVN_REPOS} trunk ${ROSE_DIST_DIR}

if [ $? -ne 0 ]; then
   echo "Error: svn_load_dirs finishes abnormally!"
   exit 3
else
  echo "svn_load_dirs.pl finishes normally."
fi

# cleanup, svn_load_dirs.pl has some trouble to clean up itself. We help it here as well
rm -rf ${UPLOAD_DIR}
rm -rf /tmp/svn_load_dirs*
