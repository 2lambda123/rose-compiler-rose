%==========================================================================
\chapter{ROSE-HPCToolkit Interface}
\label{chap:rosehpct}
%==========================================================================

The HPCToolkit (\url{http://www.hipersoft.rice.edu/hpctoolkit}) is a
set of tools for analyzing the dynamic performance behavior of
applications. It includes a tool that instruments a program's binary,
in order to observe CPU hardware counters during execution; additional
post-processing tools attribute the observed data to statements in the
original source code. HPCToolkit stores this data and the source
attributions in XML files. In this chapter, we give an overview of
simple interfaces in ROSE that can read this data and attach it to the
AST.

ROSE-HPCT is included in the ROSE distribution as an optional
module. To enable it, specify the \texttt{--enable-rosehpct} option
when running configure, and be sure that you have an existing
installation of the Gnome XML library, libxml2
(\url{http://xmlsoft.org}).

\input{\TutorialExampleBuildDirectory/roseHPCT/is-static}

%==========================================================================
\section{An HPCToolkit Example Run}
\label{chap:rosehpct:run}

%--------------------------------------------------------------------------
\begin{figure}[!h]
{\indent
{\mySmallFontSize
% Do this when processing latex to generate non-html (not using latex2html)
\begin{latexonly}
   \lstinputlisting[language=C,numbers=left,stepnumber=5]{\TutorialExampleBuildDirectory/roseHPCT/profiled.c.aa}
\end{latexonly}

% Do this when processing latex to build html (using latex2html)
\begin{htmlonly}
   \verbatiminput{\TutorialExampleBuildDirectory/roseHPCT/profiled.c.aa}
\end{htmlonly}

% end of scope in font size
}
% End of scope in indentation
}
\caption{profiled.c (part 1 of 2): Sample input program, profiled using the HPCToolkit.}
\label{Tutorial:roseHPCT:profiled:aa}
\end{figure}
%--------------------------------------------------------------------------

%--------------------------------------------------------------------------
\begin{figure}[!h]
{\indent
{\mySmallFontSize
% Do this when processing latex to generate non-html (not using latex2html)
\begin{latexonly}
   \lstinputlisting[language=C,numbers=left,stepnumber=5,firstnumber=66]{\TutorialExampleBuildDirectory/roseHPCT/profiled.c.ab}
\end{latexonly}

% Do this when processing latex to build html (using latex2html)
\begin{htmlonly}
   \verbatiminput{\TutorialExampleBuildDirectory/roseHPCT/profiled.c.ab}
\end{htmlonly}

% end of scope in font size
}
% End of scope in indentation
}
\caption{profiled.c (part 2 of 2): Sample input program, profiled using the HPCToolkit.}
\label{Tutorial:roseHPCT:profiled:ab}
\end{figure}
%--------------------------------------------------------------------------

Consider the sample source program shown in
Figures~\ref{Tutorial:roseHPCT:profiled:aa}--\ref{Tutorial:roseHPCT:profiled:ab}.
This program takes an integer $n$ on the command line, and has a
number of loops whose flop and memory-operation complexity are either
$\Theta(n)$ or $\Theta(n^2)$. For this example, we would expect the
loop nest at line 56, which has $O(n^2)$ cost, to be the most
expensive loop in the program for large $n$.

%--------------------------------------------------------------------------
\begin{figure}[!h]
{\indent
{\mySmallFontSize
% Do this when processing latex to generate non-html (not using latex2html)
\begin{latexonly}
   \lstinputlisting[language=XML,numbers=left,stepnumber=5]{\TutorialExampleBuildDirectory/roseHPCT/PAPI_TOT_CYC.xml.aa}
\end{latexonly}

% Do this when processing latex to build html (using latex2html)
\begin{htmlonly}
   \verbatiminput{\TutorialExampleBuildDirectory/roseHPCT/PAPI_TOT_CYC.xml.aa}
\end{htmlonly}

% end of scope in font size
}
% End of scope in indentation
}
\caption{XML schema for HPCToolkit data files: This schema, prepended
to each of the HPCToolkit-generated XML files, describes the format of
the profiling data. This particular schema was generated by HPCToolkit
1.0.4.}
\label{Tutorial:roseHPCT:xml:schema}
\end{figure}
%--------------------------------------------------------------------------

%--------------------------------------------------------------------------
\begin{figure}[!h]
{\indent
{\mySmallFontSize
% Do this when processing latex to generate non-html (not using latex2html)
\begin{latexonly}
   \lstinputlisting[language=XML,numbers=left,stepnumber=5,firstnumber=62]{\TutorialExampleBuildDirectory/roseHPCT/PAPI_TOT_CYC.xml.ab}
\end{latexonly}

% Do this when processing latex to build html (using latex2html)
\begin{htmlonly}
   \verbatiminput{\TutorialExampleBuildDirectory/roseHPCT/PAPI_TOT_CYC.xml.ab}
\end{htmlonly}

% end of scope in font size
}
% End of scope in indentation
}
\caption{PAPI\_TOT\_CYC.xml: Sample cycle counts observed during
profiling, generated from running the HPCToolkit on profiled.c
(Figures~\ref{Tutorial:roseHPCT:profiled:aa}--\ref{Tutorial:roseHPCT:profiled:ab}.)
These lines would appear after the schema shown in
Figure~\ref{Tutorial:roseHPCT:xml:schema}.}
\label{Tutorial:roseHPCT:xml:cycles}
\end{figure}
%--------------------------------------------------------------------------

%--------------------------------------------------------------------------
\begin{figure}[!h]
{\indent
{\mySmallFontSize
% Do this when processing latex to generate non-html (not using latex2html)
\begin{latexonly}
   \lstinputlisting[language=XML,numbers=left,stepnumber=5,firstnumber=62]{\TutorialExampleBuildDirectory/roseHPCT/PAPI_FP_OPS.xml.ab}
\end{latexonly}

% Do this when processing latex to build html (using latex2html)
\begin{htmlonly}
   \verbatiminput{\TutorialExampleBuildDirectory/roseHPCT/PAPI_FP_OPS.xml.ab}
\end{htmlonly}

% end of scope in font size
}
% End of scope in indentation
}
\caption{PAPI\_FP\_OPS.xml: Sample flop counts observed during
profiling, generated from running the HPCToolkit on profiled.c
(Figures~\ref{Tutorial:roseHPCT:profiled:aa}--\ref{Tutorial:roseHPCT:profiled:ab}.)
These lines would appear after the schema shown in
Figure~\ref{Tutorial:roseHPCT:xml:schema}.}
\label{Tutorial:roseHPCT:xml:flops}
\end{figure}
%--------------------------------------------------------------------------

Suppose we use the HPCToolkit to profile this program, collecting
cycle counts and floating-point instructions.\footnote{In this
example, HPCToolkit uses the PAPI to read CPU counters
(\url{http://icl.cs.utk.edu/papi}).} HPCToolkit will generate one XML
file for each metric.

A schema specifying the format of these XML files appears in
Figure~\ref{Tutorial:roseHPCT:xml:schema}. In essence, this schema
specifies that the XML file will contain a structured, abstract
representation of the program in terms of abstract program entities
such as ``modules,'' ``procedures,'' ``loops,'' and ``statements.''
Each of these entities may have line number information and a
``metric'' value. (Refer to the HPCToolkit documentation for more
information.) This schema is always the first part of an
HPCToolkit-generated XML profile data file.

We ran HPCToolkit on the program in
Figures~\ref{Tutorial:roseHPCT:profiled:aa}--\ref{Tutorial:roseHPCT:profiled:ab},
and collected cycle and flop counter data. The actual XML files
storing this data appear in Figures~\ref{Tutorial:roseHPCT:xml:cycles}
and~\ref{Tutorial:roseHPCT:xml:flops}. By convention, these metrics
are named according to their PAPI symbolic name, as shown on line 67
in both Figures~\ref{Tutorial:roseHPCT:xml:cycles}
and~\ref{Tutorial:roseHPCT:xml:flops}. According to the cycle data on
line 90 of Figure~\ref{Tutorial:roseHPCT:xml:cycles}, the most
expensive statement in profiled.c is line 62 of
Figure~\ref{Tutorial:roseHPCT:profiled:aa}, as expected.

%==========================================================================
\clearpage
\section{Attaching HPCToolkit Data to the ROSE AST}
\label{chap:rosehpct:attach}

To attach the data of Figures~\ref{Tutorial:roseHPCT:xml:cycles}
and~\ref{Tutorial:roseHPCT:xml:flops} to the AST, we augment a basic
ROSE translator with two additional calls, as shown in
Figure~\ref{Tutorial:roseHPCT:attach}, lines 47--48 and 54. We
describe these calls below.

%--------------------------------------------------------------------------
\begin{figure}[!h]
{\indent
{\mySmallFontSize


% Do this when processing latex to generate non-html (not using latex2html)
\begin{latexonly}
   \lstinputlisting[numbers=left,stepnumber=5]{\TutorialExampleDirectory/roseHPCT/attachMetrics.cc}
\end{latexonly}

% Do this when processing latex to build html (using latex2html)
\begin{htmlonly}
   \verbatiminput{\TutorialExampleDirectory/roseHPCT/attachMetrics.cc}
\end{htmlonly}

% end of scope in font size
}
% End of scope in indentation
}
\caption{attachMetrics.cc: Sample translator to attach HPCToolkit metrics to the AST.}
\label{Tutorial:roseHPCT:attach}
\end{figure}
%--------------------------------------------------------------------------

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Calling ROSE-HPCT}

We must first include rosehpct/rosehpct.hh, as shown on line 6 of
Figure~\ref{Tutorial:roseHPCT:attach}. All ROSE-HPCT routines and
intermediate data structures reside in the RoseHPCT namespace.

Next, lines 47--48 of Figure~\ref{Tutorial:roseHPCT:attach} store the
contents of the raw XML file into an intermediate data structure of
type RoseHPCT::ProgramTreeList\_t. The RoseHPCT::loadHPCTProfiles()
routine processes command-line arguments, extracting
ROSE-HPCT-specific options that specify the files. We discuss these
options in Section~\ref{sec:rosehpct:cmdlineopts}.

Line 54 of Figure~\ref{Tutorial:roseHPCT:attach}, attaches the
intermediate profile data structure to the ROSE AST. The
RoseHPCT::attachMetrics() routine creates new persistent attributes
that store the counter data.\footnote{The last parameter to
RoseHPCT::attachMetrics() is a boolean that, when true, enables
verbose (debugging) messages to standard error.}  The attributes are
named using the metric name taken from the XML file (see lines 67 of
Figures~\ref{Tutorial:roseHPCT:xml:cycles}--\ref{Tutorial:roseHPCT:xml:flops});
in this example, the attributes are named PAPI\_TOT\_CYC and
PAPI\_FP\_OPS. Following the conventions of persistent attribute
mechanism as described in Chapter~\ref{chap:traversals}, the
attributes themselves are of type RoseHPCT::MetricAttr, which derives
from the AstAttribute type.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Retrieving the attribute values}

We retrieve the attribute values as described in
Chapter~\ref{chap:traversals}.  In particular, given a located node
with cycle and flop attribute values, the printFlopRate() routine
defined in lines 11--42 of Figure~\ref{Tutorial:roseHPCT:attach}
prints the source position, AST node type, and estimated flops per
cycle. We call printFlopRate() for each expression statement
(SgExpressionStmt), for-initializer (SgForInitStatement), and
for-statement (SgForStatement) in lines 59--66 of
Figure~\ref{Tutorial:roseHPCT:attach}. The output is shown in
Figure~\ref{Tutorial:roseHPCT:profiled:out}.

Inspecting the output carefully, you may notice seeming discrepancies
between the values shown and the values that appear in the XML files,
or other values which seem unintuitive. We explain how these values
are derived in Section~\ref{sec:rosehpct:metprop}.

This example dumps the AST as a PDF file, as shown on line 68 of
Figure~\ref{Tutorial:roseHPCT:attach}. You can inspect this file to
confirm where attributes have been attached. We show an example of
such a page in Figure~\ref{Tutorial:roseHPCT:pdf}. This page is the
SgExprStatement node representing the sum-accumulate on line 26 of
Figure~\ref{Tutorial:roseHPCT:profiled:aa}.

\begin{figure}[!ht]
{\mySmallFontSize
  \verbatiminput{\TutorialExampleBuildDirectory/roseHPCT/profiled.out}
}
\caption{Sample output, when running attachMetrics.cc
(Figure~\ref{Tutorial:roseHPCT:attach}) with the XML inputs in
Figures~\ref{Tutorial:roseHPCT:xml:cycles}--\ref{Tutorial:roseHPCT:xml:flops}. Here,
we only show the output sent to standard output (\emph{i.e.}, cout and
not cerr).}
\label{Tutorial:roseHPCT:profiled:out}
\end{figure}

\begin{figure}[!hb]
\includegraphics[width=6in,trim=0in 7.8in 2in 0in, clip]{\TutorialExampleBuildDirectory/roseHPCT/profiled-p93.pdf}
\caption{Sample PDF showing attributes.}
\label{Tutorial:roseHPCT:pdf}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Metric propagation}
\label{sec:rosehpct:metprop}

The example program in Figure~\ref{Tutorial:roseHPCT:attach} dumps
metric values at each expression statement, for-initializer, and
for-statement, but the input XML files in
Figure~\ref{Tutorial:roseHPCT:xml:cycles}--\ref{Tutorial:roseHPCT:xml:flops}
only attribute the profile data to ``statements'' that are not loop
constructs. (The \texttt{<S \ldots>} XML tags refer to statements,
intended to be ``simple'' non-scoping executable statements; a
separate \texttt{<L \ldots>} tag would refer to a loop.) Since the XML
file specifies statements only by source line number,
RoseHPCT::attachMetrics() attributes measurements to AST nodes in a
heuristic way.

For example, lines 78--80 of Figure~\ref{Tutorial:roseHPCT:xml:cycles}
indicate that all executions of the ``simple statements'' of line 25
of the original source (Figure~\ref{Tutorial:roseHPCT:profiled:aa})
accounted for 65534 observed cycles, and that line 26 accounted for an
additional 65534 cycles. In the AST, there are multiple ``statement''
and expression nodes that occur on line 25; indeed,
Figure~\ref{Tutorial:roseHPCT:profiled:out} lists 4 such
statements.

The ROSE-HPCT modules uses a heuristic which only assigns \texttt{<S
\ldots>} metric values to non-scoping nodes derived from
SgStatement. When multiple SgStatement nodes occur at a particular
source line, ROSE-HPCT simply divides the observed metric equally
among all the SgStatement nodes on that line.

How is the measurement of 65534 cycles attributed to all of the AST
nodes corresponding to line 25 of
Figure~\ref{Tutorial:roseHPCT:profiled:aa}? Indeed, line 25 actually
``contains'' four different SgStatement nodes: an SgForStatement
representing the whole loop on lines 25--26, an SgForInitStatement
(initializer), and two SgExprStatements (one which is a child of the
SgForInitStatement, and another for the for-loop's test
expression). The loop's increment is stored in the SgForStatement node
as an SgExpression, not an SgStatement. The SgForStatement node is a
scoping statement, and so it ``receives'' none of the 65534
cycles. Since the increment is not a statement and one of the
SgExprStatements is a child of the initializer, this leaves only two
direct descendants of the SgForStatement---the initializer and the
test expression statement---among which to divide the 65534
cycles. Thus, each receives 32767 cycles. The initializer's
SgExprStatement child gets the same 32767 as its parent, since the two
nodes are equivalent (see first two cases of
Figure~\ref{Tutorial:roseHPCT:profiled:out}).

For the entire loop on lines 25--26 of
Figure~\ref{Tutorial:roseHPCT:profiled:aa}, the original XML files
attribute 65534 cycles to line 25, and another 65534 cycles to line 26
(see Figure~\ref{Tutorial:roseHPCT:xml:cycles}). Moreover, the XML
files do not attribute any costs to this loop \emph{via} an explicit
\texttt{<L \ldots>} tag. Thus, the best we can infer is that the
entire for-statement's costs is the sum of its immediate child costs;
in this case, 131068 cycles. The RoseHPCT::attachMetrics() routine
will heuristically accumulate and propagate metrics in this way to
assign higher-level scopes approximate costs.

The RoseHPCT::attachMetrics() routine automatically propagates metric
values through parent scopes. A given metric attribute,
RoseHPCT::MetricAttr* x, is ``derived'' through propagation if
x-$>$isDerived() returns true. In fact, if you call x-$>$toString() to
obtain a string representation of the metric's value, two asterisks
will be appended to the string as a visual indicator that the metric
is derived. We called RoseHPCT::MetricAttr::toString() on lines 27 and
29 of Figure~\ref{Tutorial:roseHPCT:attach}, and all of the
SgForStatement nodes appearing in the output in
Figure~\ref{Tutorial:roseHPCT:profiled:out} are marked as derived.

Alternatively, you cann call RoseHPCT::attachMetricsRaw(), rather than
calling RoseHPCT::attachMetrics().  The ``raw'' routine takes the same
arguments but only attaches the raw data, \emph{i.e.}, without
attempting to propagate metric values through parent scopes.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ROSE-HPCT command-line options}
\label{sec:rosehpct:cmdlineopts}

The call to RoseHPCT::loadHPCTProfiles() on line 48 of
Figure~\ref{Tutorial:roseHPCT:attach} processes and extracts
ROSE-HPCT-specific command-line options. To generate the output in
this chapter, we invoked Figure~\ref{Tutorial:roseHPCT:attach} with
the following command-line:

\verbatiminput{\TutorialExampleBuildDirectory/roseHPCT/command-line}

The main option is \texttt{-rose:hpct:prof <file>}, which specifies
the HPCToolkit-generated XML file containing metric data. Here, we use
this option twice to specify the names of the cycle and flop data
files
(Figures~\ref{Tutorial:roseHPCT:xml:cycles}--\ref{Tutorial:roseHPCT:xml:flops}).

We need the other option, \texttt{-rose:hpct:eqpath <A>=<B>}, to
specify how hard-coded paths in the HPCToolkit XML files map to file
paths in the ROSE AST. This option is necessary because analyzing the
HPCToolkit-generated data need not occur on the same machine or
environment in which the data was collected. In this example, the XML
files specify the source file as, ``./profiled.c'' (line 73 of
Figures~\ref{Tutorial:roseHPCT:xml:cycles}
and~\ref{Tutorial:roseHPCT:xml:flops}); the ``eqpath'' command-line
option above remaps the relative path ``.'' to an absolute path as it
would appear in the ROSE AST.

% eof
